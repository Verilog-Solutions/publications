###### tags: `Exploit Analysis Report`

Agave & Hundred Exploit @ gnosis chain Reentrancy Attack
===
> Copyright Â© 2022 by Verilog. All rights reserved.
> March 16, 2022
> by **Verilog Audit**

This is the exploit analysis report to summarize the **latest exploits on chain** found/studied by the Verilog Audit. We summairzed the hack process and important learnings.

---

## Table of Content

[TOC]


---

## Events
- **Agave(aave fork):** [https://dashboard.tenderly.co/tx/xdai/0xa262141abcf7c127b88b4042aee8bf601f4f3372c9471dbd75cb54e76524f18e](https://dashboard.tenderly.co/tx/xdai/0xa262141abcf7c127b88b4042aee8bf601f4f3372c9471dbd75cb54e76524f18e)
- **Hundred(Compound fork):**[https://dashboard.tenderly.co/tx/xdai/0x534b84f657883ddc1b66a314e8b392feb35024afdec61dfe8e7c510cfac1a098](https://dashboard.tenderly.co/tx/xdai/0x534b84f657883ddc1b66a314e8b392feb35024afdec61dfe8e7c510cfac1a098)
- **Twitter analysis**
    - [https://twitter.com/Mudit__Gupta/status/1503783633877827586?s=20&t=PRPNKqIQKk25Nvvi6EdEcw](https://twitter.com/Mudit__Gupta/status/1503783633877827586?s=20&t=PRPNKqIQKk25Nvvi6EdEcw)
    - [https://twitter.com/danielvf/status/1503756428212936710](https://twitter.com/danielvf/status/1503756428212936710)
- **similar attacks:**(****[CREAM/AMP Reentrancy Attack](https://github.com/OriginProtocol/security/blob/master/incidents/2021-08-31-Cream.md)****)

## Summuary

The exploit is related to the bridged token on the gnosis chain.

The bridged token on the gnosis chain (e.g. [WETH](https://blockscout.com/xdai/mainnet/address/0x6A023CCd1ff6F2045C3309768eAd9E68F978f6e1/transactions)) has a `callAfterTransfer(_sender, _recipient, _amount)` hook which makes the reentrancy on token transfer possible  ([bridge token implementation code](https://dashboard.tenderly.co/contract/xdai/0xf8d1677c8a0c961938bf2f9adc3f3cfda759a9d9/source))

```solidity=
function callAfterTransfer(address _from, address _to, uint256 _value) internal {
    if (AddressUtils.isContract(_to) && !contractFallback(_from, _to, _value, new bytes(0))) {
        require(!isBridge(_to));
        emit ContractFallbackCallFailed(_from, _to, _value);
    }
}

function transfer(address _to, uint256 _value) public returns (bool) {
    require(superTransfer(_to, _value));
    callAfterTransfer(msg.sender, _to, _value);
    return true;
}

function transferFrom(address _from, address _to, uint256 _value) public returns (bool) {
    require(super.transferFrom(_from, _to, _value));
    callAfterTransfer(_from, _to, _value);       <- problem here !!!
    return true;
}
```

1. **The compound did not follow the** [Checks-Effects-Interactions Pattern](https://docs.soliditylang.org/en/latest/security-considerations.html#use-the-checks-effects-interactions-pattern). ([code](https://github.com/compound-finance/compound-protocol/blob/4a8648ec0364d24c4ecfc7d6cae254f55030d65f/contracts/CToken.sol#L786))
it transfers tokens to the user first then modifies the state, which makes the reentrancy possible.
![](https://hackmd.io/_uploads/Hkbu0MlMc.png)


2. AAVE this pattern was broken via a liquidation path.


## Learning

Reentrancy issue needs to be checked before listing any token.